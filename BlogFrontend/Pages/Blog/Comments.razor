@page "/blog/comments/{BlogId:guid}"
@attribute [Authorize]
@using Blazored.LocalStorage
@using BlogFrontend.Models
@using System.Net.Http.Headers
@using Microsoft.AspNetCore.Authorization
@inject HttpClient HttpClient
@inject ILocalStorageService LocalStorage
@inject NavigationManager NavigationManager
@inject IJSRuntime JSRuntime
@inject ILocalStorageService LocalStorageService

<div class="comments-section">
    <h2>Комментарии</h2>

    @if (comments == null)
    {
        <p>Загрузка комментариев...</p>
    }
    else if (comments.Count == 0)
    {
        <p>Пока нет комментариев.</p>
    }
    else
    {
        <ul>
            @foreach (var comment in comments)
            {
                <li>
                    <div class="comment">
                        <p class="comment-content">@comment.Content</p>
                        @* <p class="comment-details">от @comment.User.UserName, @comment.CreatedAt.ToString("g")</p> *@
                    </div>
                </li>
            }
        </ul>
    }

    <div class="add-comment">
        <textarea @bind="newCommentContent" placeholder="Напишите комментарий..."></textarea>
        <button @onclick="SubmitComment">Добавить комментарий</button>
    </div>
</div>

@code {
    [Parameter] public Guid BlogId { get; set; }

    private List<CommentDto> comments;
    private string newCommentContent;
    private Guid UserId;

    protected override async Task OnInitializedAsync()
    {
        var userIdString = await LocalStorageService.GetItemAsync<string>("userId");

        if (Guid.TryParse(userIdString, out var parsedUserId))
        {
            UserId = parsedUserId;
        }
        else
        {
            Console.Error.WriteLine("Invalid User ID format.");
        }

        await LoadComments();
    }

    private async Task SetAuthorizationHeader()
    {
        var token = await JSRuntime.InvokeAsync<string>("localStorage.getItem", "jwt");

        if (!string.IsNullOrEmpty(token))
        {
            token = token.Trim('"');
            HttpClient.DefaultRequestHeaders.Authorization =
                new AuthenticationHeaderValue("Bearer", token);
        }
    }

    private async Task CreateNotification(Notification notification)
    {
        await SetAuthorizationHeader();
        var response = await HttpClient.PostAsJsonAsync("http://localhost:5205/api/Notifications/CreateNotification", notification);

        if (response.IsSuccessStatusCode)
        {
            Console.WriteLine("Notification created successfully.");
        }
        else
        {
            Console.Error.WriteLine("Failed to create notification.");
        }
    }

    private async Task LoadComments()
    {
        comments = await HttpClient.GetFromJsonAsync<List<CommentDto>>($"http://localhost:5149/api/Comments/blog/{BlogId}");
    }

    private async Task SubmitComment()
    {
        var comment = new Comment
        {
            BlogId = BlogId,
            UserId = UserId,
            Content = newCommentContent,
            CreatedAt = DateTime.UtcNow
        };

        var response = await HttpClient.PostAsJsonAsync("http://localhost:5149/api/Comments", comment);

        if (response.IsSuccessStatusCode)
        {
            newCommentContent = string.Empty;

            var notification = new Notification
            {
                UserId = UserId,
                Message = $"User {UserId} opened comments",
                Type = "Comment"
            };

            await CreateNotification(notification);
            await LoadComments();
        }
        else
        {
            Console.Error.WriteLine("Ошибка при добавлении комментария.");
        }
    }

}
